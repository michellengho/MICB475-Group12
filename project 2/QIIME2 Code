## Importing manifest.tsv file and demultiplexing into .qza file

qiime tools import \
  --type "SampleData[PairedEndSequencesWithQuality]" \
  --input-format PairedEndFastqManifestPhred33V2 \
  --input-path /mnt/datasets/project_2/human_ibd/ryan_manifest.tsv \
  --output-path demux_seqs.qza


# Create visualization of demultiplexed samples
qiime demux summarize \
  --i-data demux_seqs.qza \
  --o-visualization demux_seqs.qzv
qiime dada2 denoise-paired \
  --i-demultiplexed-seqs demux_seqs.qza \
  --p-trunc-len-f 180 \
  --p-trim-left-r 0 \
  --p-trunc-len-r 140 \
  --o-representative-sequences rep-seqs2.qza \
  --o-table table2.qza \
  --o-denoising-stats stats2.qza

screen -S visualize_stats

# Visualize DADA2 stats
qiime metadata tabulate \
  --m-input-file stats2.qza \
  --o-visualization stats2.qzv


scp -r ryan_metadata_2.0.tsv root@10.19.139.191:/data/project2_data/

screen -S visualize_ASVs


# Visualize ASVs stats
qiime feature-table summarize \
  --i-table table2.qza \
  --o-visualization table2.qzv \
  --m-sample-metadata-file /data/project2_data/ryan_metadata_2.0.tsv

screen -S visualize_feature-table

qiime feature-table tabulate-seqs \
  --i-data rep-seqs2.qza \
  --o-visualization rep-seqs2.qzv


screen -S feature_classifier

qiime feature-classifier extract-reads \
  --i-sequences /data/project2_data/rep-seqs2.qza \
  --p-f-primer TCGTCGGCAGCGTCAGATGTGTATAAGAGACAGCCTACGGGNGGCWGCAG  \
  --p-r-primer GTCTCGTGGGCTCGGAGATGTGTATAAGAGACAGGACTACHVGGGTATCTAATCC \
  --p-trunc-len-f 180
  --p-trunc-len-r 140 \ #same length used for denoising
  --o-reads ref-seqs-trimmed.qza

qiime feature-classifier extract-reads \
  --i-sequences rep-seqs2.qza \
  --p-f-primer TCGTCGGCAGCGTCAGATGTGTATAAGAGACAGCCTACGGGNGGCWGCAG \
  --p-r-primer GTCTCGTGGGCTCGGAGATGTGTATAAGAGACAGGACTACHVGGGTATCTAATCC \
  --p-trunc-len-f 180 \
  --p-trunc-len-r 140 \  
  --o-reads ref-seqs-trimmed.qza

# Train classifier with your new ref-seq file
# Replace ref-taxonomy.qza with the representative taxonomy file on the server (e.g. /mnt/datasets/silva_ref_files/silva-138-99-tax.qza)

qiime feature-classifier fit-classifier-naive-bayes \
  --i-reference-reads ref-seqs-trimmed.qza \
  --i-reference-taxonomy /data/project2_.data/< taxonomy.qza > \
  --o-classifier classifier.qza

# Use the trained classifier to assign taxonomy to your reads (rep-seqs.qza)
qiime feature-classifier classify-sklearn \
  --i-classifier classifier.qza \
  --i-reads rep-seqs.qza \
  --o-classification taxonomy.qza

#Create Visualization
qiime metadata tabulate \
  --m-input-file taxonomy.qza \
  --o-visualization taxonomy.qzv
  
# Taxonomy barplots
qiime taxa barplot \
  --i-table table.qza \
  --i-taxonomy taxonomy.qza \
  --m-metadata-file /data/project2_data/new_ryan_metadata.tsv \
  --o-visualization taxa-bar-plots.qzv


#Filtering out mitochondria and chloroplast 
qiime taxa filter-table \
  --i-table table.qza \
  --i-taxonomy taxonomy.qza \
  --p-exclude mitochondria,chloroplast \
  --o-filtered-table table-no-mitochondria-no-chloroplast.qza

# Frequency-based filtering (optional)
qiime feature-table filter-features \
--i-table table.qza \
--p-min-frequency 8 \
--o-filtered-table feature-frequency-filtered-table.qza
